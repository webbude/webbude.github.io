<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script src="html2canvas.min.js"></script>

    <link rel="icon" type="image/png" href="schei_favicon_96x96.png" sizes="32" />
    <title>Unschuldsvermutung</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            text-align: center;
            background: gold;
            color: gold;
            font-size: 18px;
        }
        h1 {
            color:gold;
            font-weight: 600;
        }
        .container {
            max-width: 1080px;
            /*background: #0d5232;*/
        }
        .col { 
            /*border: 1px solid green;*/
            padding: 0;
        }
        
        #kopf {
            /*position:relative;
            left:0;
            right:0;
            top:150px; */
            max-width: 90%;
            margin-bottom: 30px;
            max-height: 900px;
        }
        .schei {
            max-width: 50px;
            max-height: 50px;
        }
        .schei.original {
            cursor:pointer;
        } 
        .schei.active {
            /*border: 1px solid red;*/
            -webkit-filter: drop-shadow(0px 0px 10px red);
            filter: drop-shadow(0px 0px 10px red);
        }


        canvas {
           display:none; 
        }
        .audio #unschuldsvermutung, #img_input {
            display: inline-block;
            max-width: 200px;
            height: 45px;
        }
   

        .schei_cont {
            display: inline-block;
        } 
        #control {
           display: inline-block;
        }
        #control button {
            display: inline-block;
            font-size: 20px;
            font-weight: 900;
            width:40px;
            height: 40px;
            padding: 5px;
        }
        #info_button {
            font-size: 30px; 
            line-height: 30px; 
            font-weight: 900; 
            
            height:60px; 
            border-radius: 30px; 
            padding: 3px 5px 6px 5px;
        }
        .score {
            color: gold;
            font-size: 30px;
            text-shadow: 0px 0px 3px black;
        }
        .offcanvas {
            text-align: left;
            background:rgb(5, 124, 55);
            height: 60%;
        }
        
        @media (min-width: 992px) {
            .schei {
                max-width: 80px;
                max-height: 80px;
            }
        }
    </style>
  </head>
  <body class="bg-success">
    
    <div class="container ">
        <h1 class="d-inline" style="margin-right: 20px;">Unschuldsvermutung</h1>&nbsp; 
        <button  id="info_button" class="btn btn-primary btn-lg d-inline" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasTop" aria-controls="offcanvasTop" title="Hilfe, Info!">‚ìò Anleitung!</button> 
          
        <div class="row">
            
            <div class="img_input col">
                <input type="file" id="img_input"  class="btn btn-warning" title="Anderes Bild laden" />
                <canvas id="upload" style="display: none;"></canvas>
            </div>
            <div id="control" class="col" title="Schei√üe vergr√∂√üern, verkleinern, drehen">
                <button class="rot_left btn btn-warning">‚Ü∫</button>
                <button class="rot_right btn btn-warning">‚Üª</button>
                <button class="scale_up btn btn-warning">+</button>
                <button class="scale_down btn btn-warning">-</button>
            </div>
            
            <div class="col">
                <button id="screenshot" class="btn btn-warning" title="screenshot">üì∑ Foto</button> 
            </div>

        </div>
        <div class="row">   
            <div class="audio col">
                <audio id="unschuldsvermutung" class="border-warning border-5 border rounded" title="Lied abspielen" controls>
                    <source src="unschuldsvermutung.mp3" type="audio/ogg">
                    Your browser does not support the audio tag.
                </audio>
            </div>
            <div class="schei_cont col" class="Schei√üe zum drapieren">
                Schei√üe: 
                <img class="schei original" id="schei_1" src="schei_1.png" style="left: 200px;" />

                <img class="schei original" id="schei_2" src="schei_2.png" style="left: 400px;" />

                <img class="schei original" id="schei_3" src="schei_3.png" style="left: 600px;" />
            </div>
            

           
            <div class="col score">
                Score: <span id="score">0</span>
            </div>
            
        </div>
    </div>
    <img id="kopf" src="kopf_1.png" />
    
    

    <div class="offcanvas offcanvas-top" tabindex="-1" id="offcanvasTop" aria-labelledby="offcanvasTopLabel">
        <div class="offcanvas-header">
            <h5 id="offcanvasTopLabel">Spielanleitung!</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <p>
                
                Bitte horche dir das Lied an, ab dem <b>Refrai</b> kannst du die Schei√üe auf das Bild ziehen.<br />
                Das Bild kann auch ausgetauscht werden, zu diesem Zweck nutze den Fileupload Button.
                <br />
                Schei√üe plazieren funktioniert wie folgt:<br />
                Zuerst eine Schei√üe am oberen Rand vom Bild aktivieren, die aktive Schei√üe kann nun verg√∂√üert, verkleinert, gedreht und plaziert werden. 
            </p>
            <p>
                
                Am Schluss kann man noch ein Erinnerungsfoto anfertigen. (Ein Screenshot funktioniert besser!)<br />
                Viel Spass!

            </p>
        </div>
    </div>
            
    
    

    <script type="text/javascript">
        var isPlaying = false;
        


        $( document ).ready(function() {
            //img_input------------------------------------------------------------------
            document.getElementById('img_input').onchange = function(e) {
                var img = new Image();
                img.onload = draw;
                img.onerror = failed;
                img.src = URL.createObjectURL(this.files[0]);
            };
            function draw() {
                var canvas = document.getElementById('upload');
                canvas.width = this.width;
                canvas.height = this.height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(this, 0,0);
                var kopf_src = canvas.toDataURL("image/png"); 
                $('#kopf').attr('src',kopf_src);
            }
            function failed() {
                console.error("The provided file couldn't be loaded as an Image media");
            }
            
            
            //active control----------------------------------
            $('#control button').on('click',function(event){
                var current_rotation = parseInt($('.schei.active').attr('current_rotation'));
                var current_scale = parseFloat($('.schei.active').attr('current_scale'));
                if($(this).hasClass('rot_left')) {
                    current_rotation=current_rotation-10;
                };
                if($(this).hasClass('rot_right')) {
                    current_rotation=current_rotation+10;
                };
                if($(this).hasClass('scale_up')) {
                    current_scale = current_scale+0.1;
                };
                if($(this).hasClass('scale_down')) {
                    current_scale = current_scale-0.1;
                };
                $('.schei.active').css('transform','rotate('+ current_rotation +'deg) scale('+ current_scale +')').attr('current_rotation',current_rotation).attr('current_scale',current_scale);
                event.stopPropagation();
            }); 

            
            $('.schei.original').on('click',function(event){
                activateSchei($(this));
                event.stopPropagation();
            });
            $('body').click(function(){$('.schei').removeClass('active');});

            var unschuldsvermutung = $('#unschuldsvermutung')[0];
            unschuldsvermutung.onpause = function() {
                isPlaying = false;
            };
            unschuldsvermutung.onplay = function() {
                isPlaying = true;
            };
            unschuldsvermutung.ontimeupdate = function() {
                isPlaying = unschuldsvermutung.currentTime > 30 ? true : false;
            } 

            $('.schei .col .form-range').change(function(){
                $(this).parent().find('img');
            });
            //schreenshot---------------------------------------------------------------
            $('#screenshot').click(function(){
                
                
                html2canvas(document.body,{}).then(function(canvas) {
                    //document.body.appendChild(canvas);
                    saveAs(canvas.toDataURL(), 'screenshot.png');
                    
                });
                
            });
            function saveAs(uri, filename) {
                var link = document.createElement('a');
                if (typeof link.download === 'string') {
                link.href = uri;
                link.download = filename;

                //Firefox requires the link to be in the body
                document.body.appendChild(link);

                //simulate click
                link.click();

                //remove the link when done
                document.body.removeChild(link);
                } else {
                window.open(uri);
                }
            }
            //schreenshot---------------------------------------------------------------
        });
        
        function activateSchei(el) {
            //isPlaying=true;
            if(!isPlaying) return;
            var off = el.offset();
            var cl = null;
            if(el.hasClass('original')) {
                cl = el.clone(true).appendTo('body').attr('id','').attr('current_rotation','0').attr('current_scale','1');
                cl.css({'position':'absolute','width':el.width()+'px','height':el.height()+'px','top':off.top+'px','left':off.left+'px','cursor':'move'});
                cl.removeClass('original');
            }
            else {
                cl = el;
            }
            dragElement(cl[0]);
        }
        var count_score = 0;
        var pling = new Audio('audio_pling.mp3');
        var sirene = new Audio('audio_sirene.mp3');
        pling.volumen = 0.5;
        sirene.volumen = 0.5;

        function score() {
            var pos =  $('#kopf').offset();
            var width = $('#kopf').width();
            var height = $('#kopf').height();
            var counter = 0;
            $('.schei').each(function(){
               var el_offset = $(this).offset();
               if(el_offset.top > pos.top && el_offset.top < pos.top+height && el_offset.left > pos.left && el_offset.left < pos.left+width) {
                   counter++;
               }
               
            });
            $('#score').html(counter*100);
            console.log(Number.isInteger(counter/10));
            if(counter > 0 && Number.isInteger(counter/10)){
                sirene.currentTime = 0;
                sirene.play(); 
            }
            pling.currentTime = 0;
            pling.play();
        }

        function dragElement(elmnt) {
            $('.schei').removeClass('active');
            $(elmnt).addClass('active');
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            if (document.getElementById(elmnt.id + "header")) {
                // if present, the header is where you move the DIV from:
                document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
                document.getElementById(elmnt.id + "header").ontouchstart = dragMouseDown;
            } else {
                // otherwise, move the DIV from anywhere inside the DIV:
                elmnt.onmousedown = dragMouseDown;
                elmnt.ontouchstart = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.ontouchend = closeDragElement;
                // call a function whenever the cursor moves:
                document.ontouchmove = elementDrag;
                document.onmousemove = elementDrag;
                
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                score();
                // stop moving when mouse button is released:
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            }
        }
    </script>
    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
    -->
  </body>
</html>
